<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <template id="portal_my_subscriptions_inh"
        inherit_id="sale_subscription.portal_my_subscriptions">
        <xpath expr="//t[@t-call='portal.portal_layout']" position="replace">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True" />

                <t t-call="portal.portal_searchbar">
                    <t t-set="title">Suscripciones</t>
                </t>
                <t t-if="not accounts">
                    <p>No tiene suscripciones activas</p>
                </t>
                <t t-if="accounts" t-call="portal.portal_table">
                    <thead>
                        <tr class="active">
                            <th class="w-75">Suscripciones</th>
                            <th class="text-center">Patente</th>
                            <th class="text-center">Fecha de inicio</th>
                            <th class="text-center">Fecha devolución</th>
                            <th class="text-center">Estado</th>
                            <th class="text-right">Total</th>
                            <th class="text-right">Contrato</th>
                            <th class="text-right">Anexo A</th>
                            <th class="text-right">Anexo B</th>
                            <th class="text-right">Anexo C</th>
                            <th class="text-right">Acta de entrega</th>
                            <th class="text-right">Acta de devolución</th>
                        </tr>
                    </thead>
                    <t t-foreach="accounts" t-as="account">
                        <tr>
                            <td>
                                
                                    <t t-esc="account.code[0:6]" />
                                
                            </td>
                            <td>
                                <span t-esc="account.vehicle_id.license_plate" />
                            </td>
                            <td>
                                <span t-esc="account.date_start.strftime('%d/%m/%Y')" />
                            </td>
                            <td>
                                <span t-esc="account.date.strftime('%d/%m/%Y')" />
                            </td>
                            <td class="text-center" id="subscription_state">
                                <t
                                    t-if="account.stage_category == 'progress' and not account.to_renew">
                                    <span class="badge badge-pill badge-success">
                                        <i class="fa fa-fw fa-check" /> En progreso </span>
                                </t>
                                <t t-if="account.to_renew">
                                    <span class="badge badge-pill badge-warning">
                                        <i class="fa fa-fw fa-refresh" /> Para renovar </span>
                                </t>
                                <t t-if="account.stage_category == 'closed'">
                                    <span class="badge badge-pill badge-danger">
                                        <i class="fa fa-fw fa-remove" /> Finalizado </span>
                                </t>
                            </td>
                            <td class="text-right">
                                <span t-esc="account.recurring_total_incl"
                                    t-options="{'widget': 'monetary', 'display_currency': account.currency_id}" />
                            </td>
                            <td>
                                <t t-if="account.attach_1">
                                    <a t-attf-href="/my/subscription/#{account.id}/download/1">
                                        <i class="fa fa-download" /> 
                                    </a>
                                </t>
                            </td>
                            <td>
                                <t t-if="account.attach_2">
                                    <a t-attf-href="/my/subscription/#{account.id}/download/2">
                                        <i class="fa fa-download" /> 
                                    </a>
                                </t>
                            </td>
                            <td>
                                <t t-if="account.attach_3">
                                    <a t-attf-href="/my/subscription/#{account.id}/download/3">
                                        <i class="fa fa-download" /> 
                                    </a>
                                </t>
                            </td>
                            <td>
                                <t t-if="account.attach_4">
                                    <a t-attf-href="/my/subscription/#{account.id}/download/4">
                                        <i class="fa fa-download" /> 
                                    </a>
                                </t>
                            </td>
                            <td>
                                <t t-if="account.attach_5">
                                    <a t-attf-href="/my/subscription/#{account.id}/download/5">
                                        <i class="fa fa-download" /> 
                                    </a>
                                </t>
                            </td>
                            <td>
                                <t t-if="account.attach_6">
                                    <a t-attf-href="/my/subscription/#{account.id}/download/6">
                                        <i class="fa fa-download" /> 
                                    </a>
                                </t>
                            </td>
                        </tr>
                    </t>
                </t>
            </t>


        </xpath>

    </template>

    <template id="subscription_inh" inherit_id="sale_subscription.subscription">
        <xpath expr="//t[@t-call='portal.portal_layout']" position="replace">
            <t t-call="portal.portal_layout">
                <t t-set="wrapwrap_classes" t-value="'o_portal_bg_dark'" />

                <div class="row mt16 oe_website_contract o_portal_sidebar">

                    <!-- ====== Sidebar  ====== -->
                    <t t-call="portal.portal_record_sidebar">
                        <t t-set="classes" t-value="'col-lg-auto d-print-none'" />

                        <t t-set="entries">
                            <ul
                                class="list-group list-group-flush flex-wrap flex-row flex-lg-column">
                                <li class="list-group-item flex-grow-1">
                                    <div>
                                        <strong> Próxima fecha de pago: <span
                                                t-field="account.recurring_next_date" />
                                        </strong>
                                    </div>
                                    <div>
                                        <strong> Monto: <span t-field="account.recurring_total_incl"
                                                t-options='{"widget": "monetary","display_currency": account.pricelist_id.currency_id}' />
                                        </strong>
                                    </div>
                                    <a
                                        t-if="account.stage_category == 'progress' and not account.to_renew and account.template_id and display_change_plan"
                                        role="button" class="mt8 btn btn-primary"
                                        t-att-href="'/my/subscription/'+str(account.id)+'/change'+'?uuid='+str(account.uuid)">Change
                                        plan</a>
                                    <div t-if="account.payment_token_id"> Payment method: <t
                                            t-if="account.payment_token_id.name"
                                            t-esc="account.payment_token_id.name" />
                                        <t t-else="">Unknown
                                        token</t>
                                    </div>
                                    <t
                                        t-if="not account.to_renew and account.stage_category == 'progress'">
                                        <!-- User is logged in under the partner set on the
                                        subscription -->
                                        <t t-if="user.partner_id == account.partner_id">
                                            <a t-if="acquirers or tokens" role="button"
                                                class="mt8 btn btn-secondary" data-toggle="modal"
                                                data-target="#payment_managing" href="#">
                                                <t t-if="account.payment_token_id">Manage Payment
                                                    Method</t>
                                                <t t-else="">Set Payment Method</t>
                                            </a>
                                        </t>
                                        <!-- User is logged in under a partner different than that
                                        set on the subscription -->
                                        <button
                                            t-elif="not user._is_public() and user.partner_id != account.partner_id"
                                            title="Managing payment methods requires to be logged in under the customer account."
                                            href="#"
                                            disabled="true"
                                            role="button"
                                            class="mt8 btn btn-secondary">
                                            Manage Payment Methods
                                        </button>
                                        <!-- User is logged out -->
                                        <a t-elif="acquirers or tokens"
                                            title="You must be logged in to manage your payment methods."
                                            t-attf-href="/web/login?redirect=/my/subscription/{{account.id}}/{{account.uuid}}"
                                            role="button"
                                            class="mt-8 btn btn-secondary">
                                            Manage Payment Methods
                                        </a>
                                    </t>
                                </li>
                                <li t-if="display_close" class="list-group-item flex-grow-1">
                                    <a role="button" data-toggle="modal"
                                        data-target="#wc-modal-close" href="#">Close Subscription</a>
                                </li>
                                <div class="o_download_pdf btn-toolbar flex-sm-nowrap">

                                    <div class="btn-group flex-grow-1 mb-1">
                                        <a
                                            class="btn btn-secondary btn-block o_print_btn o_portal_invoice_print"
                                            t-attf-href="/report/pdf/subscription_agreement.subscription_agreement_document_new_inh/#{account.id}"
                                            id="subscription_agreement_document_new_inh"
                                            title="Print" target="_blank">
                                            <i class="fa fa-print" /> Imprimir </a>
                                    </div>
                                </div>
                                <div class="o_download_pdf_2 btn-toolbar flex-sm-nowrap">

                                    <div class="btn-group flex-grow-1 mb-1">
                                        <a
                                            class="btn btn-secondary btn-block o_print_btn o_portal_invoice_print2"
                                            t-attf-href="/report/pdf/subscription_agreement.subscription_agreement_delivery_new_inh/#{account.id}"
                                            id="partner_agreement_delivery_subscription"
                                            title="Print Receipt" target="_blank">
                                            <i class="fa fa-print" /> Imprimir Recibo de entrega </a>
                                    </div>
                                </div>

                                <t t-if="account.stage_category == 'closed'">
                                    <div class="o_download_pdf_3 btn-toolbar flex-sm-nowrap">

                                        <div class="btn-group flex-grow-1 mb-1">
                                            <a
                                                class="btn btn-secondary btn-block o_print_btn o_portal_invoice_print3"
                                                t-attf-href="/report/pdf/subscription_agreement.subscription_agreement_defund_new_inh/#{account.id}"
                                                id="partner_agreement_refund_subscription"
                                                title="Print refund" target="_blank">
                                                <i class="fa fa-print" /> Imprimir Recibo de
                                                devolución </a>
                                        </div>
                                    </div>
                                </t>

                                <li t-if="account.user_id" class="list-group-item flex-grow-1">
                                    <div class="small mb-1">
                                        <strong class="text-muted">Representante:</strong>
                                    </div>
                                    <div class="row flex-nowrap">
                                        <div class="col flex-grow-0 pr-2">
                                            <img
                                                class="rounded-circle mr4 float-left o_portal_contact_img"
                                                t-attf-src="#{image_data_uri(account.user_id.avatar_1024)}"
                                                alt="Contact" />
                                        </div>
                                        <div class="col pl-0" style="min-width: 150px">
                                            <span t-field="account.user_id"
                                                t-options='{"widget": "contact", "fields": ["name", "phone"], "no_marker": True}' />
                                            <div>
                                                <a t-if="is_follower" href="#discussion"
                                                    class="small">
                                                    <i class="fa fa-comment"></i> Send message </a>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </t>
                    </t>

                    <!-- ====== Page Content  ====== -->
                    <div class="col-12 col-lg">
                        <div class="card oe_website_contract">
                            <div class="card-header bg-white pb-2 pt-3">
                                <div class="row">
                                    <div class="col-12 col-lg flex-grow-1 mb-1 mb-lg-0">
                                        <h4 class="mb-0">
                                            <small class="text-muted">Preview CONTRATO DE
                                                ARRENDAMIENTO DE VEHICULO -</small>
                                            <span t-esc="account.code[0:6]" />
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 col-lg flex-grow-1 mb-1 mb-lg-0">
                                    <div class="col-6 col-lg flex-grow-1 mb-1 mb-lg-0"
                                        style="margin-left:80px;width:80%;">
                                        <h3 style="text-align:center;font-weight: bold;">
                                            <t t-if="account.attach_1">
                                                <a t-attf-href="?/download/1">
                                                    Contrato ,
                                                </a>
                                            </t>
                                            <t t-if="account.attach_2">
                                                <a t-attf-href="#{ account.id }/download/2">
                                                    Anexo 1 ,
                                                </a>
                                            </t>
                                            <t t-if="account.attach_3">
                                                <a t-attf-href="#{ account.id }/download/3">
                                                    Anexo 2 ,
                                                </a>
                                            </t>
                                            
                                        </h3>


                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ======  Chatter ====== -->
                        <div t-if="is_follower" id="discussion">
                            <h3 class="mt-4">History</h3>
                            <t t-call="portal.message_thread">
                                <t t-set="object" t-value="account" />
                                <t t-set="chatter_mode" t-value="'json'" />
                            </t>
                        </div>
                    </div>

                    <!-- ======  MODAL: Close Subscription ====== -->
                    <div role="dialog" class="modal fade" id="wc-modal-close" t-if="display_close"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <header class="modal-header">
                                    <h4 class="modal-title">Close Subscription</h4>
                                </header>
                                <form method="post"
                                    t-attf-action="/my/subscription/#{account.id}/close/?uuid=#{account.uuid}">
                                    <input class="d-none" name="csrf_token"
                                        t-att-value="request.csrf_token()" />
                                    <main class="modal-body">
                                        <p> If you confirm, your subscription will be closed right
                                            away. Your current invoicing period is valid until <span
                                                t-field="account.recurring_next_date" /> . </p>
                                        <p>We always listen to our customer. Could you specify the
                                            reason for cancelling your subscription?</p>
                                        <div class="form-group">
                                            <select class="form-control" name="close_reason_id">
                                                <t t-foreach="close_reasons" t-as="close_reason">
                                                    <option t-att-value="close_reason.id"
                                                        t-esc="close_reason.name" />
                                                </t>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <textarea class="form-control" name="closing_text"
                                                style="width: 100%;" rows="4"></textarea>
                                        </div>
                                    </main>
                                    <footer class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-dismiss="modal">Cancel</button>
                                        <button class="btn btn-primary contract-submit">Confirm</button>
                                    </footer>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </t>

        </xpath>

    </template>


</odoo>